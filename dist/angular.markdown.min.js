/**
 * angular.markdown
 * @version v0.0.1 - 2015-03-08
 * @link https://github.com/xiyiaoo/angular.markdown
 * @author null <xiyiaoo@gmail.com>
 * @license m License, http://www.opensource.org/licenses/m
 */
"use strict";angular.module("angular.markdown",["ngSanitize"]).run(["$templateCache",function(a){a.put("editor.template.html",'<div class="editor-container"><div ng-show="editor.isPreview" markdown="content" class="editor-content"></div><textarea ng-style="{\'height\':editor.rownums*20+14+\'px\'}" ng-hide="editor.isPreview" ng-model="content" name="editorContent" required ng-minlength="{{min}}" ng-maxlength="{{max}}"></textarea><div class="editor-toolbar"><ul class="pull-left"><li><a href="http://wowubuntu.com/markdown/" target="_blank"><i class="fa fa-question-circle fa-btn" title="查看markdown语法"></i></a></li><li action="preview"><i class="fa fa-btn" title="预览/取消预览" ng-class="{\'fa-eye\': !editor.isPreview, \'fa-eye-slash\': editor.isPreview}"></i></li><li action="insertImg"><i class="fa fa-photo fa-btn" title="插入图片" ng-hide="editor.isPreview"></i></li><li action="insertLink"><i class="fa fa-link fa-btn" title="插入链接" ng-hide="editor.isPreview"></i></li><li action="insertCode"><i class="fa fa-code fa-btn" title="插入代码" ng-hide="editor.isPreview"></i></li></ul><button class="pull-right editor-submit btn" ng-if="needSubmit()" ng-click="submit()" ng-disabled="cannotSubmit()">评论一下</button></div></div>')}]).factory("mdParser",["$sanitize","$window",function(a,b){var c=new marked.Renderer;return c.code=function(a,c,d){if(this.options.highlight){var e=this.options.highlight(a,c);null!==e&&e!==a&&(d=!0,a=e)}var f="hljs "+(c&&this.options.langPrefix+b.escape(c,!0)||"");return'<pre><code class="'+f+'">'+(d?a:b.escape(a,!0))+"</code></pre>"},marked.setOptions({highlight:function(a){return b.hljs&&b.hljs.highlightAuto(a).value},renderer:c}),{parse:function(b){return b=b||"",a(marked(b))}}}]).directive("markdown",["mdParser",function(a){return function(b,c,d){d.markdown?b.$watch(d.markdown,function(b){var d=a.parse(b);c.html(d)}):c.html(a.parse(c.text()))}}]).directive("mdEditor",["mdParser","$window",function(a,b){return{restrict:"EA",replace:!0,templateUrl:"editor.template.html",scope:{content:"=mdEditorModel",settting:"@mdEditorSettting",submit:"&mdEditorSubmit",min:"@mdEditorMinlength",max:"@mdEditorMaxlength",formname:"@mdEditorFormname"},link:function(a,c){var d={};d.isFullScreen=!1,d.isPreview=!1,d.rownums=3,a.editor=d;var e=a.range||"";e=e.split(","),a.range={},a.range.min=+e[0]||1,a.range.min=+e[1]||1e3,a.needSubmit=function(){return angular.isFunction(a.submit)},a.cannotSubmit=function(){return!a.$parent[a.formname]||a.$parent[a.formname].$invalid};var f=c.find("textarea");f.bind("keyup",function(a){(13===a.which||8===a.which||a.ctrlKey&&(86===a.which||88===a.which))&&g.calcRownum()}),f=f[0];var g={calcRownum:function(){var b=f.value.split("\n").length+1;3>b&&(b=3),b!==d.rownums&&a.$apply(function(){d.rownums=b})},beFocus:function(){b.setTimeout(function(){f.focus()},100)},preview:function(){var b=this;a.$apply(function(){d.isPreview=!d.isPreview,d.isPreview||b.beFocus()})},insertImg:function(){var a,c,d=b.prompt("请输入图片的地址");d&&(a=this.getCursorIndex(),c="![图片描述]("+d+")",this.insertContent(c),this.setSelection(a+2,a+6))},insertLink:function(){var a,c,d=b.prompt("请输入链接的地址");d&&(a=this.getCursorIndex(),c="[连接名称]("+d+")",this.insertContent(c),this.setSelection(a+1,a+5))},insertCode:function(){var a,b,c=this.getSelection();c=c?"\n```\n"+c+"\n```":"\n```\n\n```",a=this.getCursorIndex()+5,b=a+c.length-9,5===a&&(c=c.substring(1),a--,b--),this.insertContent(c),this.setSelection(a,b),this.beFocus(),this.calcRownum()},getSelection:function(){var a=f.selectionStart,b=f.selectionEnd;return f.value.substring(a,b)},getCursorIndex:function(){return f.selectionStart},getContent:function(){return f.value},insertContent:function(a,b,c){(isNaN(b)||isNaN(c))&&(b=f.selectionStart,c=f.selectionEnd);var d=f.value;d=d.substring(0,b)+a+d.substring(c),f.value=d},setSelection:function(a,b){b=b||a,f.selectionStart=a,f.selectionEnd=b}};c.children().children().eq(-1).bind("click",function(a){var b=a.target;"I"===b.tagName&&(b=b.parentNode);var c=g[b.getAttribute("action")];angular.isFunction(c)&&c.call(g,b)}),c.children().eq(0).bind("click",function(){g.preview()})}}}]);